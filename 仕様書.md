# PDFPW 仕様書

## 1. 目的

ブラウザ上でPDFスライドを用いたプレゼンを行うWebアプリを提供します。
**Speaker（ホスト）＋Audience（子）**の2ウィンドウ構成を前提とし、ホストが状態の正を持ち、子は表示専用とします。

## 2. 非目的

* サーバー側でのPDF保管、配信、同期は行いません。
* OPFS（Origin Private File System）は利用しません。
* アカウント／クラウド同期／共有リンク発行は対象外です。
* 描画（annotation/drawing）の永続保存は行いません（セッション限り）。([Debian Manpages][1])

---

## 3. 画面構成（最小）

### 3.1 ホーム（起動エントリ）

**目的**：PDFを開いてSpeakerを起動します。
**方針**：ホームは薄くし、選択後はSpeakerへリダイレクトします。

**機能（共通）**

* PDFを開く（D&D／ファイル選択）
* 選択完了後、Speakerへリダイレクト

**機能（File System Access API 利用可能時のみ）**

* 「最近開いたファイル」一覧を表示

  * クリックでそのPDFを開いてSpeaker起動
  * 履歴から削除、全消去（任意）
* 判定条件：`showOpenFilePicker` が利用できること（Chromium系想定）([Chrome for Developers][2])

**削除（簡略化）**

* ホーム内チュートリアル：なし
* ホーム内サムネイル表示：なし（Overviewで必要になった時だけ生成）

---

### 3.2 プレゼン（単一実装・2モード）

同一のプレゼン画面を `mode` で分岐します。

* Speaker（ホスト）：`?mode=speaker`
* Audience（子）：`?mode=audience`

#### Speaker（ホスト）

* 現在スライド表示
* 次スライドプレビュー
* ノート表示（簡易）
* タイマー（経過／カウントダウン）
* 進捗（user slide基準）
* ツールボックス（ポインタ／ペン／消しゴム／スポットライト）
* Overview（サムネイルのグリッド）([Debian Manpages][1])

#### Audience（子）

* クリーン表示（ノート／UIなし）
* ポインタ、スポットライト、描画（設定で反映ONの場合のみ）
* 誤操作防止：入力は原則無効（表示専用）

---

## 4. 2ウィンドウ運用

### 4.1 起動フロー

1. ホームでPDFを選択（または最近ファイルを選択）
2. Speakerへリダイレクト（ホスト起動）
3. Speaker上の「Audienceを開く」ボタン（ユーザー操作）で `window.open()` し子を起動

   * ポップアップブロック時は、同ボタンの再提示／手動起動導線を表示

### 4.2 役割分担

* ホスト（Speaker）：状態の正／入力受付／子への同期配信
* 子（Audience）：レンダリング専用／ホスト状態を反映するだけ

---

## 5. overlays（ユーザースライド）対応

pdfpc同様、PDFのページ（slides）と論理スライド（user slides）を区別します。([Ubuntu Manpage][3])

### 5.1 自動グルーピング

* 既定で overlay の自動検出を行います（pdfpcはページラベルを用いる）。([Debian Manpages][1])
* 自動検出が合わない場合、Speakerで「このページはoverlay継続」をトグル可能（例：Ctrl+o相当）。([Debian Manpages][1])

### 5.2 ナビゲーションの意味

* 通常の次／前：**1ページずつ（overlayの途中も進む）**([Ubuntu Manpage][3])
* user slide移動：**Shift+PageDown/Up で次/前の user slide**（overlay残りをスキップ）([Debian Manpages][1])

---

## 6. Overview（グリッド一覧）

* TabでOverviewを開き、サムネイルをグリッド表示してジャンプします。([Debian Manpages][1])
* サムネイルはOverview表示時に遅延生成してよい（ホームでは生成しない）

---

## 7. ツール／注釈（pdfpc寄せ）

### 7.1 モード（数字キーで切替）

* 1：通常（全OFF）
* 2：ポインタ
* 3：ペン
* 4：消しゴム
* 5：スポットライト([Debian Manpages][1])

### 7.2 サイズ調整

* * / -：現在モードに応じてサイズ変更（ポインタ／ペン／消しゴム／スポットライト）([Debian Manpages][1])

### 7.3 描画の扱い

* 描画は user slide 単位で保持（overlay内のページで共有）
* **描画はセッション間で保存しない**([Debian Manpages][1])
* c：現在ページの描画をクリア、d：描画の表示切替（必要ならpdfpc互換）([Debian Manpages][1])

### 7.4 Spotlight

* マウス追従の円形スポットで、周囲を暗くする表現（pdfpc相当）。([Debian Manpages][1])

---

## 8. Freeze（投影だけ停止）

* f：Audience表示をフリーズ／解除（Speaker側は操作継続）([Debian Manpages][1])
* ブラックアウト（b）とは別扱いにします。([Debian Manpages][1])

---

## 9. ノート（簡易・pdfpc寄せ）

* ノートは **プレーンテキスト**の簡易編集とします（リッチ編集なし）。([Ubuntu Manpage][3])
* Ctrl+n で編集モード、Escで終了
* 編集中はキー操作（スライド移動等）を無効化します。([Debian Manpages][1])

※pdfpcはノートを .pdfpc に保存しますが、Web版はサーバーなしのため「保存ポリシー」は後述に従います。

---

## 10. タイマー（pdfpc寄せ）

* duration指定がある場合はカウントダウン、未指定なら経過時間表示。([Debian Manpages][1])
* **最初のページから初めて離れたタイミングで自動開始**します。([Debian Manpages][1])
* Ctrl+t：タイマーリセット（web実装では同等操作を提供）([Debian Manpages][1])

---

## 11. キーバインド（MVPの基準）

基本は pdfpc のデフォルトに寄せます。([Debian Manpages][1])

* 次へ：PageDown / Enter / Space / →
* 戻る：PageUp / ←
* user slide移動：Shift+PageDown / Shift+PageUp（overlayスキップ）([Debian Manpages][1])
* Overview：Tab([Debian Manpages][1])
* Goto：g（ページ番号入力）([Debian Manpages][1])
* ツール：1〜5（前述）([Debian Manpages][1])
* Freeze：f([Debian Manpages][1])
* ブラックアウト：b([Debian Manpages][1])
* ノート編集：Ctrl+n / Esc([Debian Manpages][1])
* タイマー：s開始、p一時停止、Ctrl+tリセット（必要なら）([Debian Manpages][1])

Audience側は原則ショートカット無効（表示専用）です。

---

## 12. 同期（ホスト→子）

### 12.1 同期対象（最低限）

* 現在ページ（slide番号／user slide番号）
* overlay状態（現在のoverlay内位置）
* ブラックアウト／フリーズ
* ツールモード（1〜5）、サイズ
* ポインタ／スポットライト座標
* 描画イベント（差分）

### 12.2 同期方式（簡略）

* `postMessage` を基本とします（ホストが `window.open()` した子へ送る）。
* 子は起動・リロード時に `HELLO` を送信し、ホストが `STATE` を返して復帰させます（子リロード耐性）。

---

## 13. データ保存・最近開いたファイル・リロード復元

### 13.1 前提

File System Access API は **対応ブラウザが限られる**ため、利用可否で挙動を分岐します（`showOpenFilePicker` の有無）。([MDN 웹 문서][4])
また、このAPIはHTTPSなどのセキュアコンテキスト前提です。([MDN 웹 문서][4])

### 13.2 File System Access API 利用可能時（Chromium系想定）

* 最近開いたファイル一覧を表示（ホーム）
* `FileSystemFileHandle` を IndexedDB に保存して履歴化します（復元のため）。([MDN 웹 문서][5])
* リロード復元：

  * 保存済みハンドルがあれば、権限状態を確認し（`queryPermission`／必要なら `requestPermission`）、許可されれば同じPDFを再読込して復元します。([mdn2.netlify.app][6])
  * 権限拒否・失効・ファイル消失なら復元しません（ホームへ戻す）

### 13.3 利用不可時（Firefox/Safari等）

* 最近開いた一覧は表示しません（ホームは単純なファイル選択のみ）
* ホストがリロードした場合はセッション終了（再選択が必要）

### 13.4 OPFSは非対応

* OPFSを使った復元は実装しません（方針固定）。

---

## 14. パフォーマンス（pdfpc相当の考え方）

* ページ切替を滑らかにするため、近傍ページのプリレンダ／キャッシュを行ってよい（上限あり）。([Debian Manpages][1])
* Overview用のサムネイルは遅延生成（必要になった時だけ）。

---

## 15. テスト観点（MVP）

* 2ウィンドウ：open、同期、子リロード復帰（HELLO→STATE）
* overlay：自動検出、Shift+PageDown/Up の user slide移動([Debian Manpages][1])
* Overview：Tabで表示、ジャンプ([Debian Manpages][1])
* Freeze：fでAudience停止、解除([Debian Manpages][1])
* ツール：1〜5切替、+/-サイズ変更、描画は保存されない([Debian Manpages][1])
* タイマー：初回ページ遷移で自動開始、Ctrl+tリセット([Debian Manpages][1])
* File System Access API：最近開いた一覧、権限拒否時のフォールバック、リロード復元の成否([MDN 웹 문서][4])

---

必要なら、次はこの仕様をそのまま実装タスクに落とせるように「メッセージ定義（HELLO/STATE/EVT）」「overlayのデータモデル（slide↔user slide対応表）」「最近開いたのIndexedDBスキーマ」を短く追記します。

[1]: https://manpages.debian.org/testing/pdf-presenter-console/pdfpc.1 "pdfpc(1) — pdf-presenter-console — Debian testing — Debian Manpages"
[2]: https://developer.chrome.com/docs/capabilities/web-apis/file-system-access?utm_source=chatgpt.com "The File System Access API: simplifying access to local files"
[3]: https://manpages.ubuntu.com/manpages/focal/man1/pdfpc.1.html "Ubuntu Manpage:

       pdfpc - PDF presenter console with multi-monitor support
    "
[4]: https://developer.mozilla.org/ja/docs/Web/API/Window/showOpenFilePicker?utm_source=chatgpt.com "Window.showOpenFilePicker() - Web API | MDN"
[5]: https://developer.mozilla.org/en-US/docs/Web/API/File_System_API?utm_source=chatgpt.com "File System API - MDN Web Docs"
[6]: https://mdn2.netlify.app/en-us/docs/web/api/filesystemfilehandle/?utm_source=chatgpt.com "FileSystemFileHandle - Web APIs"
